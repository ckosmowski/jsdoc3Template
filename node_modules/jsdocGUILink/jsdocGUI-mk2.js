(function(){
	"use strict";
	
	var constants = require('./constants.js'),
		Deferred = require('deferreds').Deferred
	;

	module.exports = function jsdoc3Exec(INPUT_DIR){
		var deferred = new Deferred();

		var child_process = require('child_process'),
			jsdoc,
			command = constants.jsdocExec + ' -X -r ' + INPUT_DIR
		;
//		console.log('\tExecuting: ' + command);

		jsdoc = child_process.exec(
			command,
			{
				maxBuffer: 2000000,
				encoding: 'utf-8'
			},
			function(error, stdout, stderr){
				var data = stdout.split('\u0008\u007F', stdout),
					toReturn = {
						warnings: '',
						data: {}
					}
				;
				
				
				if(data[1]){
					toReturn.warnings = data[0];
					toReturn.doclets = JSON.parse(data[1]);
				}else{
					toReturn.doclets = JSON.parse(data[0]);
				}
				
				deferred.resolve(toReturn);
			}
		);
		jsdoc.on('error', function(err){
			deferred.fail(err);
		});
		
		return deferred.promise();

	}
})();

