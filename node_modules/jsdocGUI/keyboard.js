(function(nwWindow){
	var window = nwWindow.window,
		$ = window.jQuery
	;
	var keyboardHandler = {
		/**
		 * @description Initialize the handler
		 */
		init: function(){
			var me = this;
			$(document).ready(function(){
				$(document).bind('keyup', {}, function(e){
					return me._keyStroke(e);
				}, true);
			});
		},
		
		/**
		 * @protected
		 * @desc Handle the keyup event
		 * 
		 * @param {Event}	e	Event with the definition of the release key
		 * 
		 * @return {Boolean}	True if the event must be prevented
		 *						
		 * @see http://api.jquery.com/category/events/event-object/
		 * @see http://api.jquery.com/keyup/
		 * 
		 * @fires document."Key.$KEY$"
		 */
		_keyStroke: function(e){
			if($(e.target).is('input,select,textarea')){
				//#############################################################
				//# RETURN en caso de que el elemento donde se hace la accion 
				//#		sea un input, select o Textarea.
				//#############################################################
				return false;
			}
			var key = '', ret={preventDefault: false};
			
			if(e.ctrlKey || e.keyCode === 17){
				key += 'Ctrl';
			}
			if(e.altKey || e.keyCode === 18){
				key += 'Alt';
			}
			if(e.shiftKey || e.keyCode === 16){
				key += 'Shift';
			}
			if(e.metaKey || e.keyCode === 91 || e.keyCode === 92){
				key += 'Meta';
			}
			
			switch(e.keyCode){
				case 8:key += 'BackSpace';break;
				case 9:key += 'Tab';break;
				case 13:key += 'Enter';break;
				
				case 16:
				case 17:
				case 18:
				case 91:
				case 92:
				break;
				
				
				case 19:key += 'Pause';break;
				case 27:key += 'Esc';break;
				case 32:key += 'Space';break;
				
				case 33:key += 'PageUp';break;
				case 34:key += 'PageDown';break;
				
				case 35:key += 'End';break;
				case 36:key += 'Home';break;
				
				case 37:key += 'Left';break;
				case 38:key += 'Up';break;
				case 39:key += 'Right';break;
				case 40:key += 'Down';break;
				
				case 45:key += 'Insert';break;
				case 46:key += 'Del';break;
				
				case 112:key += 'F1';break;
				case 113:key += 'F2';break;
				case 114:key += 'F3';break;
				case 115:key += 'F4';break;
				case 116:key += 'F5';break;
				case 117:key += 'F6';break;
				case 118:key += 'F7';break;
				case 119:key += 'F8';break;
				case 120:key += 'F9';break;
				case 121:key += 'F10';break;
				case 122:key += 'F11';break;
				case 123:key += 'F12';break;
				default:
					if(e.keyCode > 126){
						key += 'CODE_' + e.keyCode;
					}else{
						key += String.fromCharCode(e.keyCode);
					}
			}

			$(document).trigger('Key.' + key, ret);

			return !ret.preventDefault;
		}
	};
	
	keyboardHandler.init();
}( require('nw.gui').Window.get() ));