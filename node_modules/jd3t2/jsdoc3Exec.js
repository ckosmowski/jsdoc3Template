(function(){
	"use strict";
console.log('jsdoc3Exec');
	var constants = require('./constants.js'),
		Deferred = require('deferreds/Deferred')
	;

	module.exports = function jsdoc3Exec(INPUT_DIR){
		var deferred = new Deferred();

		var child_process = require('child_process'),
			jsdoc,
			command = constants.jsdocExec + ' -X -l -r ' + INPUT_DIR
		;
//		console.log('\tExecuting: ' + command);

		jsdoc = child_process.exec(
			command,
			{
				maxBuffer: 2000000,
				encoding: 'utf-8'
			},
			function(error, stdout, stderr){
				var data = stdout.toString().split('\u0000\u0000'),
					toReturn = {
						warnings: '',
						data: {}
					}
				;
console.log('jsdoc3 output');
console.log(data);

				try{
					if(data[1]){
						toReturn.warnings = data[0];
						toReturn.doclets = JSON.parse(data[1]);
					}else{
						toReturn.doclets = JSON.parse(data[0]);
					}

					deferred.resolve(toReturn);
				}catch(e){
					console.log('ERROR TRYING TO PARSE JSON, command, error, stdout, stderr, data');
					console.log(command);
					console.log(error);
					console.log(stdout);
					console.log(stderr);
					console.log(data);
				}
			}
		);
		jsdoc.on('error', function(err){
			deferred.fail(err);
		});
		
		return deferred.promise();
	}
})();

